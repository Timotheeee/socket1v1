<!DOCTYPE html>
<html style="height: 100%;">
    <head>
        <meta charset="UTF-8">
        <!--<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />-->
        <!--<meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"/>-->
        <meta name="viewport" content="target-densitydpi=device-dpi width=device-width minimum-scale=0.65 initial-scale=0.65 maximum-scale=0.65 user-scalable=0"/>
        <title>PVP simulator</title>
        <script type="text/javascript" src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
        <script type="text/javascript" src="jquery.js"></script>
        <script type="text/javascript" src="data.js"></script>
        <script type="text/javascript" src="gamemaster.js"></script>
        <script type="text/javascript" src="default_team.js"></script>
        <script type="text/javascript" src="battlelogic.js"></script>

        <link href="style.css" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Roboto&display=swap" rel="stylesheet">
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    </head>
    <body class="noselect">
        <div class="bgcontainer">
            <input type="text" id="pokebattlerid" placeholder="pokebattler id"> 
            <a id="loadteam" class="button noselect">
                <strong>load</strong>
            </a>
            <a id="ready" class="button button-green noselect">
                <i class="fa fa-check"></i> <strong>Ready</strong>
            </a>
            <br>
            <span id="pokebattlerinfo"></span>
        </div>

        <div class="bgcontainer" style="height:510px">
            <h1 style="margin-top: 3px">PVP simulator </h1>
            <div class="hp" style="width:364px" id="hp1"></div>
            <div class="pokeimage" id='img1' style='background-image: url("question.PNG")'></div><!--https://play.pokemonshowdown.com/sprites/xydex/quagsire.png-->
            <img src="shield.png" id="shield1" alt="shield">
            <span id="shieldcount1">2</span>



            <img src="shield.png" id="shield2" alt="shield">
            <span id="shieldcount2">2</span>
            <div class="hp" style="width:364px" id="hp2"></div>
            <div class="pokeimage" id='img2' style='background-image: url("question.PNG")'></div>
            <div id="win"></div>
        </div>
        <div id="buttons"  class="bgcontainer">
            <div id="quickmovecontainer"><b>quick move:</b> <span id="quickmovebtn">mud shot</span></div>
            <div id="chargemove1container">
                <div id="chargemove1btn" class="movebtn noselect rock active"></div>
                <div id="move1progress" style="height: 60px">                
                    <div id="move1background" class="rock"></div>
                </div>

                <div id="chargemove1text" class="">stone edge</div>
            </div>

            <div id="chargemove2container" >
                <div id="chargemove2btn" class="movebtn noselect ground"></div>
                <div id="move2progress" style="height:60px">
                    <div id="move2background" class="ground"></div>
                </div>
                <div id="chargemove2text" class="">earthquake</div>
            </div>


        </div>
        <div id='switch' class="bgcontainer"><b>switch: </b>
            <button id='switch1' name="0"></button>
            <button id='switch2' name="1"></button>
            <button id='switch3' name="2"></button>
            <b>cooldown:</b> <span id='cd'>0</span>
        </div>
        <div id='lobby' class="bgcontainer">
            <div id="playercountcontainer">
                <b>players online:</b> <span id="playercount">1</span>
            </div>
            <div id="lobbynumbercontainer">
                <b>lobby number:</b> <span id="lobbynumber">0</span>/1000
            </div>
            <div id="playercountinlobbycontainer">
                <b>players in your lobby:</b> <span id="playercountinlobby">1</span>/2
            </div>
            <div id="changelobbycontainer">
                <input type="text" id="lobbyinput"><button id="changelobbybtn">change lobby</button>
            </div>
        </div>



        <br>


        <script>
            var gm = GameMaster.getInstance();

            var currentpoke = 0;
            var currentenemypoke = 0;

            var started = false;
            display("waiting for opponent");
            var sentendpacket = false;

            var switchcd = 0;

            var team;
            var enemyteam;

            var shields = 2;
            var oshields = 2;

            var move = "";

            var opponentshielding = false;
            var shielding = false;
            var doingcharge = false;
            var chargeincoming = false;

            var winner = -1;

            var socket;
            if (window.location.href.includes("heroku")) {
                socket = io.connect(window.location.href.replace("http", "ws"));
            } else {
                socket = io.connect('http://178.82.224.106:3000/');
            }



            console.log(socket);




            function initteam(teamdata) {
                var team2 = [];
                team2.push(JSON.parse(JSON.stringify(teamdata)).battleParties[0].attacker1);
                team2.push(JSON.parse(JSON.stringify(teamdata)).battleParties[0].attacker2);
                team2.push(JSON.parse(JSON.stringify(teamdata)).battleParties[0].attacker3);
                for (var i = 0; i < 3; i++) {
                    team2[i].name = team2[i].pokemon.replace("_FORM", "");
                    var p = gm.getPokemonById(team2[i].name.toLowerCase());
                    var cpm = cpms[(team2[i].level - 1) * 2];
                    var cmove1 = gm.getMoveById(team2[i].cinematicMove);
                    var cmove2 = gm.getMoveById(team2[i].cinematicMove2);

                    team2[i].hp = Math.floor((p.baseStats.hp + team2[i].individualStamina) * cpm);
                    team2[i].atk = (p.baseStats.atk + team2[i].individualAttack) * cpm;
                    team2[i].def = (p.baseStats.def + team2[i].individualDefense) * cpm;
                    team2[i].energy = 0;
                    team2[i].req1 = cmove1.energy;
                    team2[i].req2 = cmove2.energy;
                    team2[i].ctype1 = cmove1.type;
                    team2[i].ctype2 = cmove2.type;
                    team2[i].quickMoveDelay = (gm.getMoveById(team2[i].quickMove.replace("_FAST", "")).cooldown) / 500;
                    team2[i].atkboosts = 0;
                    team2[i].defboosts = 0;
                    team2[i].cmove1 = cmove1;
                    team2[i].cmove2 = cmove2;
                }
                return team2;
            }

            setTimeout(function () {
                team = initteam(defaultteamdata);
                enemyteam = initteam(defaultteamdata);
            }, 1);

            socket.on('lobbypos', function (data) {
                $("#lobbynumber").text(data.lobbypos + 1);
            });
            socket.on('lobbycount', function (data) {
                if (data.count === 1 && started) {
                    display("the enemy disconnected, refresh the page");
                    started = false;
                }
                $("#playercountinlobby").text(data.count);
            });

            socket.on('dmg',
                    function (data) {
                        //console.log("Got: " + data.move);
                        chargeincoming = false;
                        if (convertToEnergy(data.move) < 0) {
                            chargeincoming = true;
                            var btn = "<button class='shieldbtn '>shield</button>";
                            display("charge move incoming!" + (shields > 0 ? btn : ""));
                        }
                        setTimeout(function () {
                            team[currentpoke].hp -= shielding ? 1 : convertToDamage(data.move, false);
                            if (team[currentpoke].hp < 1 && doingcharge) {//prevent bug
                                team[currentpoke].hp = 1;
                                //return;
                            }
                            updateHP();
                            var movedata = gm.getMoveById(data.move);

                            //acid spray
                            //console.log(movedata);
                            if (movedata.buffApplyChance && movedata.buffApplyChance === 1) {
                                console.log(movedata);
                                if (movedata.buffTarget === "opponent") {
                                    team[currentpoke].atkboosts += movedata.buffs[0];
                                    team[currentpoke].defboosts += movedata.buffs[1];
                                } else {
                                    enemyteam[currentenemypoke].atkboosts += movedata.buffs[0];
                                    enemyteam[currentenemypoke].defboosts += movedata.buffs[1];
                                }
                                limitboosts();
                            }

                            if (chargeincoming)
                                display("the charge move was " + data.move.toLowerCase().replace("_", " "));
                            setTimeout(function () {
                                if ($("#win").html().includes("the charge move was "))
                                    display("")
                            }, 1500);
                            shielding = false;
                            chargeincoming = false;
                        }, chargeincoming ? 3000 : 0);


                    }
            );

            socket.on('shield', function (data) {
                if (oshields === 0)
                    return;
                opponentshielding = true;
                display("opponent shielded");
                oshields--;
            });
            socket.on('switch', function (data) {
                //console.log("switch");
                //console.log(data);
                currentenemypoke = data.id;
                if ($("#win").html().includes("the opponent is choosing their next pokemon!"))
                    display("");
            });
            socket.on('playercount', function (data) {
                $("#playercount").text(data.count);
            });
            socket.on('enemychoseteam', function (data2) {
                //console.log("enemychoseteam" + data2.id);
                if (data2.id === "") {
                    enemyteam = initteam(defaultteamdata);
                } else
                    $.get("https://fight.pokebattler.com/profiles/" + data2.id, {}, function (data) {
                        try {
                            //console.log(data);
                            enemyteam = initteam(data);
                        } catch (e) {

                            console.log(e);
                        }
                    });
            });


            //switch or use a move
            var turnswaited = 0;
            setInterval(function () {
                if (move === "" || doingcharge || chargeincoming || winner >= 0)
                    return;
                if (move.includes("switch")) {
                    if (team[currentpoke].hp > 0)
                        switchcd = 30;
                    currentpoke = parseInt(move.split("_")[1]);
                    updateMoveButtons();
                    move = currentQuickMove();
                    socket.emit('switch', {id: currentpoke});
                    turnswaited = 0;
                    if ($("#win").html().includes("choose your next pokemon!"))
                        display("");
                }
                if (team[currentpoke].hp < 1) {
                    switchcd = 0;
                    display("choose your next pokemon!");
                    return;
                }
                if (enemyteam[currentenemypoke].hp < 1) {
                    display("the opponent is choosing their next pokemon!");
                    return;
                }

                //using the move
                /*
                 * case 1: quick move
                 * case 2: not enough energy
                 * case 3: enough energy
                 * case 4: we have enough energy with 1 more quick move (undertap)
                 **/

                var quickmovedelta = convertToEnergy(currentQuickMove());
                var movedelta = -1 * convertToEnergy(move);
                var nextenergy = team[currentpoke].energy + quickmovedelta;
//                var nextenergy2 = team[currentpoke].energy + quickmovedelta*2;
                var undertap = nextenergy >= movedelta;
                var nextcharge = move;

                doingcharge = true;
                if (move === currentQuickMove()) {
                    doingcharge = false;
                    //console.log("case1");
                    turnswaited++;
                    if (currentQuickMoveDelay() > turnswaited)
                        return;
                    turnswaited = 0;


                } else if (nextenergy < movedelta) {
                    doingcharge = false;
                    //console.log("case2");
                    move = currentQuickMove();
                    turnswaited++;
                    if (currentQuickMoveDelay() > turnswaited)
                        return;
                    turnswaited = 0;


                } else if (team[currentpoke].energy >= movedelta) {
                    //console.log("case3 " + movedelta + " " + team[currentpoke].energy);
                    //no problem

                } else if (undertap) {
                    doingcharge = false;
                    //console.log("case4 undertap");
                    move = currentQuickMove();
                    turnswaited++;
                    if (currentQuickMoveDelay() > turnswaited)
                        return;
                    turnswaited = 0;
                } else {
                    console.log("wtf");
                }

                movedelta *= -1;
                //console.log(team[currentpoke].energy);
                //console.log(move);



                socket.emit('dmg', {move});
                if (doingcharge)
                    display("waiting for opponent to shield")

                setTimeout(function () {
                    console.log(team[currentpoke].atkboosts);
                    enemyteam[currentenemypoke].hp -= (opponentshielding ? 1 : convertToDamage(move, true));
                    if ($("#win").html().includes("opponent shielded") || $("#win").html().includes("waiting for opponent to shield"))
                        display("");
                    team[currentpoke].energy += convertToEnergy(move);
                    team[currentpoke].energy = team[currentpoke].energy > 100 ? 100 : team[currentpoke].energy;

                    var movedata = gm.getMoveById(move);

                    if (movedata.buffApplyChance && movedata.buffApplyChance === 1) {
                        console.log(movedata);
                        if (movedata.buffTarget === "self") {
                            team[currentpoke].atkboosts += movedata.buffs[0];
                            team[currentpoke].defboosts += movedata.buffs[1];
                        } else {
                            enemyteam[currentenemypoke].atkboosts += movedata.buffs[0];
                            enemyteam[currentenemypoke].defboosts += movedata.buffs[1];
                        }
                        limitboosts();
                    }

                    updateHP();
                    updateEn();
                    //console.log(move);

                    opponentshielding = false;
                    console.log(undertap);
                    move = undertap ? nextcharge : currentQuickMove();
                    if(doingcharge)move=currentQuickMove();
                    doingcharge = false;
                }, doingcharge ? 3000 : 0);


            }, 500);


            socket.on('start', function (data) {
                setTimeout(function () {
                    display("3");
                    var id = $("#pokebattlerid").val();
                    socket.emit('enemychoseteam', {id});
                }, 0);
                setTimeout(function () {
                    display("2")
                }, 1000);
                setTimeout(function () {
                    display("1")
                }, 2000);
                setTimeout(function () {
                    display("");
                    move = currentQuickMove();
                    started = true;
                }, 3000);
            });












            //------------------------------------------------------------------------------------------------------------
            //INTERFACE STUFF
            var ready = false;
            $('#ready').click(function () {
                if (!ready) {
                    ready = true;
                    socket.emit('ready', {id: socket.id});
                }

            });
            $("#loadteam").click(function () {
                if (started)
                    return;
                var id = $("#pokebattlerid").val();
                $.get("https://fight.pokebattler.com/profiles/" + id, {}, function (data) {
                    try {
                        //console.log(data);
                        //teamdata = data;
                        team = initteam(data);
                        //socket.emit('enemychoseteam', {id});//removed for privacy
                        updateMoveButtons();
                        updateSwitchButtons();
                    } catch (e) {
                        $("#pokebattlerinfo").text("an error occured. make sure your first battle party has the 3 pokemon you want to use and refresh this page");
                        console.log(e.message);
                    }
                });
            });


            $('body').on("click", "#chargemove1container", function (e) {
                if (!started)
                    return;
                move = team[currentpoke].cinematicMove;
            });
            $('body').on("click", "#chargemove2container", function (e) {
                if (!started)
                    return;
                move = team[currentpoke].cinematicMove2;
            });
            $('body').on("click", ".shieldbtn", function (e) {
                shields--;
                shielding = true;
                socket.emit('shield', {});
                $(this).hide();
            });
            $('body').on("click", "#switch button", function (e) {
                if (!doingcharge)
                    move = "switch_" + $(this).attr("name");
            });
            $("#changelobbybtn").click(function () {
                if (started)
                    return;
                var n = Number.parseInt($("#lobbyinput").val());
                if (!isNaN(n) && n > 0 && n < 1001) {
                    socket.emit('lobbyrequest', {num: (n - 1)});
                }
            });

            setInterval(function () {
                $("#cd").text(switchcd);
                $("#shieldcount2").text(shields);
                $("#shieldcount1").text(oshields);
                //https://play.pokemonshowdown.com/sprites/xydex/deoxys-defense.png
                //question.PNG
                if (started) {
                    $("#img" + 1).css("background-image", "url(https://play.pokemonshowdown.com/sprites/xydex/" + enemyteam[currentenemypoke].name.toLowerCase().replace("_", "-") + ".png)");
                } else {
                    $("#img" + 1).css("background-image", "url(question.PNG)");
                }
                $("#img" + 2).css("background-image", "url(https://play.pokemonshowdown.com/sprites/xydex/" + team[currentpoke].name.toLowerCase().replace("_", "-") + ".png)");

                disableSwitchButton(team[currentpoke].name);
                updateHP();
                updateEn();
                if (winner >= 0) {
                    if (!sentendpacket) {
                        sentendpacket = true;
                        socket.emit('end', {});
                    }
                    display(winner === 1 ? "you win" : "you lose");
                }
            }, 50);

            function display(text) {
                //console.log("display: " + text);
                if (!$("#win").html().includes("enemy disconnected"))
                    $("#win").html(text);
            }

            function disableSwitchButton(poke) {

                for (var i = 0; i < 3; i++) {
                    $("button[name='" + i + "']").attr("disabled", team[i].hp < 1);
                }
                $("button[name='" + poke + "']").attr("disabled", true);
                if (!(switchcd === 0 && started))
                    $("#switch button").attr("disabled", true);
            }
            function updateSwitchButtons() {
                for (var i = 0; i < 3; i++) {
                    $("#switch" + (i + 1)).css("background-image", "url(https://play.pokemonshowdown.com/sprites/xydex/" + team[i].name.toLowerCase().replace("_", "-") + ".png)");
                }
            }
            setInterval(function () {
                switchcd--;
                if (switchcd < 0)
                    switchcd = 0;
            }, 1000);

            function updateHP() {
                if (winner >= 0) {
                    display(winner === 1 ? "you win" : "you lose");
                    return;
                }
                if (team[0].hp < 1 && team[1].hp < 1 && team[2].hp < 1)
                    winner = 0;
                if (enemyteam[0].hp < 1 && enemyteam[1].hp < 1 && enemyteam[2].hp < 1)
                    winner = 1;

                $("#hp2").css({width: (team[currentpoke].hp * 1.8)});
                $("#hp1").css({width: (enemyteam[currentenemypoke].hp * 1.8)});
            }
            function updateEn() {
                //$("#enin").css({width: (team[currentpoke].energy)});
                //console.log(team[currentpoke].energy);
                $("#move1progress").css({height: (80 * team[currentpoke].energy / team[currentpoke].req1)});
                $("#move2progress").css({height: (80 * team[currentpoke].energy / team[currentpoke].req2)});
                if (team[currentpoke].energy >= team[currentpoke].req1) {
                    $("#chargemove1btn").addClass("active")
                } else {
                    $("#chargemove1btn").removeClass("active")
                }
                if (team[currentpoke].energy >= team[currentpoke].req2) {
                    $("#chargemove2btn").addClass("active")
                } else {
                    $("#chargemove2btn").removeClass("active")
                }

            }
            function updateMoveButtons() {
                var q = currentQuickMove();
                var c1 = team[currentpoke].cinematicMove;
                var c2 = team[currentpoke].cinematicMove2;
                $("#quickmovebtn").text(q.toLowerCase().replace("_", " ").replace("_", " "));
                $("#chargemove1btn").data("name", c1);
                $("#chargemove1text").text(c1.toLowerCase().replace("_", " ").replace("_", " "));
                $("#chargemove2btn").data("name", c2);
                $("#chargemove2text").text(c2.toLowerCase().replace("_", " ").replace("_", " "));

                //console.log(team[currentpoke].ctype1);
                for (var i = 1; i < 3; i++) {
                    $("#chargemove" + i + "btn").attr("class", "movebtn noselect " + team[currentpoke]["ctype" + i + ""]);
                    $("#move" + i + "background").attr("class", team[currentpoke]["ctype" + i + ""]);
                }



                updateEn();
            }
            function currentQuickMove() {
                return team[currentpoke].quickMove.replace("_FAST", "");
            }
            function currentQuickMoveDelay() {
                return team[currentpoke].quickMoveDelay;
            }





        </script>

    </body>
</html>